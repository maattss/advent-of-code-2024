using System.Diagnostics;

namespace AdventOfCode2024;

public static class Day5
{
    public static void PrintQueue()
    {
        var stopwatch = Stopwatch.StartNew();
        const string input = "48|74\n95|99\n95|97\n94|23\n94|98\n94|56\n19|98\n19|83\n19|62\n19|75\n83|58\n83|49\n83|61\n83|92\n83|93\n75|64\n75|58\n75|39\n75|83\n75|14\n75|24\n59|98\n59|95\n59|23\n59|55\n59|65\n59|69\n59|94\n77|62\n77|28\n77|57\n77|76\n77|34\n77|15\n77|11\n77|26\n72|47\n72|57\n72|81\n72|26\n72|34\n72|28\n72|87\n72|76\n72|19\n87|69\n87|29\n87|63\n87|17\n87|94\n87|57\n87|65\n87|23\n87|33\n87|11\n99|69\n99|29\n99|27\n99|28\n99|81\n99|68\n99|34\n99|77\n99|19\n99|94\n99|76\n98|92\n98|72\n98|23\n98|61\n98|55\n98|69\n98|74\n98|91\n98|39\n98|97\n98|14\n98|63\n14|36\n14|76\n14|99\n14|34\n14|68\n14|11\n14|25\n14|87\n14|19\n14|64\n14|93\n14|39\n14|27\n27|87\n27|55\n27|57\n27|69\n27|19\n27|94\n27|17\n27|65\n27|36\n27|76\n27|29\n27|26\n27|98\n27|68\n97|27\n97|52\n97|72\n97|24\n97|99\n97|87\n97|64\n97|11\n97|39\n97|25\n97|82\n97|59\n97|74\n97|36\n97|57\n82|29\n82|87\n82|62\n82|68\n82|94\n82|57\n82|81\n82|76\n82|11\n82|36\n82|28\n82|77\n82|69\n82|34\n82|19\n82|25\n63|39\n63|52\n63|93\n63|47\n63|25\n63|48\n63|95\n63|64\n63|58\n63|91\n63|56\n63|65\n63|61\n63|83\n63|14\n63|92\n63|72\n24|77\n24|36\n24|33\n24|11\n24|59\n24|15\n24|34\n24|68\n24|27\n24|19\n24|98\n24|28\n24|81\n24|76\n24|17\n24|99\n24|57\n24|82\n15|55\n15|95\n15|65\n15|63\n15|91\n15|74\n15|23\n15|69\n15|92\n15|81\n15|14\n15|49\n15|75\n15|58\n15|48\n15|61\n15|83\n15|33\n15|29\n52|24\n52|25\n52|27\n52|76\n52|34\n52|47\n52|64\n52|82\n52|87\n52|36\n52|28\n52|59\n52|94\n52|72\n52|68\n52|26\n52|62\n52|57\n52|19\n52|11\n91|87\n91|24\n91|92\n91|48\n91|82\n91|39\n91|64\n91|95\n91|14\n91|25\n91|93\n91|77\n91|72\n91|58\n91|61\n91|76\n91|99\n91|52\n91|97\n91|47\n91|56\n74|57\n74|72\n74|19\n74|28\n74|47\n74|25\n74|87\n74|24\n74|11\n74|82\n74|77\n74|59\n74|76\n74|94\n74|36\n74|17\n74|52\n74|26\n74|68\n74|93\n74|34\n74|27\n34|63\n34|62\n34|36\n34|49\n34|33\n34|81\n34|91\n34|15\n34|17\n34|94\n34|29\n34|59\n34|65\n34|75\n34|55\n34|61\n34|83\n34|98\n34|28\n34|58\n34|69\n34|95\n34|23\n17|81\n17|15\n17|95\n17|23\n17|61\n17|97\n17|63\n17|75\n17|62\n17|33\n17|65\n17|94\n17|14\n17|98\n17|55\n17|56\n17|49\n17|29\n17|58\n17|91\n17|28\n17|83\n17|69\n17|48\n92|57\n92|68\n92|93\n92|72\n92|27\n92|52\n92|74\n92|24\n92|59\n92|47\n92|77\n92|94\n92|19\n92|76\n92|17\n92|36\n92|87\n92|11\n92|26\n92|25\n92|64\n92|99\n92|82\n92|34\n93|17\n93|94\n93|28\n93|62\n93|76\n93|19\n93|26\n93|59\n93|27\n93|57\n93|25\n93|52\n93|64\n93|34\n93|68\n93|11\n93|77\n93|82\n93|72\n93|36\n93|99\n93|24\n93|47\n93|87\n28|58\n28|81\n28|15\n28|95\n28|14\n28|83\n28|56\n28|61\n28|48\n28|97\n28|23\n28|92\n28|33\n28|55\n28|98\n28|69\n28|65\n28|62\n28|91\n28|63\n28|49\n28|29\n28|75\n28|39\n25|11\n25|34\n25|81\n25|59\n25|17\n25|29\n25|62\n25|26\n25|69\n25|94\n25|68\n25|75\n25|55\n25|27\n25|28\n25|19\n25|33\n25|76\n25|15\n25|87\n25|77\n25|36\n25|57\n25|98\n47|64\n47|81\n47|15\n47|34\n47|57\n47|59\n47|24\n47|77\n47|28\n47|99\n47|68\n47|25\n47|27\n47|19\n47|76\n47|11\n47|87\n47|62\n47|82\n47|26\n47|98\n47|17\n47|36\n47|94\n81|56\n81|93\n81|92\n81|75\n81|74\n81|58\n81|29\n81|65\n81|48\n81|39\n81|49\n81|33\n81|55\n81|52\n81|14\n81|98\n81|95\n81|61\n81|91\n81|63\n81|69\n81|97\n81|23\n81|83\n68|28\n68|11\n68|33\n68|62\n68|29\n68|55\n68|34\n68|59\n68|49\n68|65\n68|69\n68|17\n68|23\n68|58\n68|63\n68|98\n68|81\n68|83\n68|26\n68|36\n68|91\n68|75\n68|15\n68|94\n69|83\n69|14\n69|56\n69|23\n69|39\n69|61\n69|49\n69|72\n69|65\n69|52\n69|58\n69|29\n69|97\n69|75\n69|63\n69|91\n69|24\n69|47\n69|95\n69|55\n69|92\n69|48\n69|93\n69|74\n11|17\n11|65\n11|33\n11|98\n11|26\n11|58\n11|29\n11|75\n11|81\n11|83\n11|69\n11|62\n11|49\n11|55\n11|91\n11|28\n11|94\n11|15\n11|34\n11|59\n11|36\n11|63\n11|23\n11|61\n29|14\n29|49\n29|47\n29|72\n29|74\n29|23\n29|55\n29|48\n29|52\n29|91\n29|92\n29|56\n29|83\n29|61\n29|39\n29|93\n29|63\n29|65\n29|75\n29|24\n29|95\n29|58\n29|97\n29|64\n64|81\n64|17\n64|57\n64|28\n64|11\n64|76\n64|26\n64|33\n64|77\n64|36\n64|98\n64|27\n64|34\n64|87\n64|62\n64|19\n64|69\n64|82\n64|59\n64|15\n64|25\n64|68\n64|94\n64|99\n61|39\n61|93\n61|56\n61|47\n61|27\n61|87\n61|99\n61|82\n61|68\n61|76\n61|48\n61|64\n61|72\n61|14\n61|19\n61|97\n61|77\n61|24\n61|92\n61|52\n61|74\n61|95\n61|57\n61|25\n58|39\n58|19\n58|24\n58|82\n58|27\n58|76\n58|14\n58|56\n58|61\n58|99\n58|93\n58|25\n58|57\n58|97\n58|47\n58|48\n58|74\n58|87\n58|92\n58|72\n58|95\n58|77\n58|52\n58|64\n55|63\n55|65\n55|95\n55|93\n55|61\n55|23\n55|97\n55|72\n55|49\n55|99\n55|74\n55|82\n55|24\n55|47\n55|64\n55|39\n55|14\n55|92\n55|56\n55|52\n55|58\n55|91\n55|48\n55|83\n49|95\n49|47\n49|99\n49|76\n49|57\n49|48\n49|77\n49|27\n49|93\n49|87\n49|56\n49|72\n49|25\n49|61\n49|97\n49|74\n49|58\n49|14\n49|52\n49|24\n49|39\n49|64\n49|92\n49|82\n26|63\n26|58\n26|14\n26|94\n26|61\n26|91\n26|65\n26|81\n26|49\n26|23\n26|83\n26|29\n26|33\n26|95\n26|55\n26|48\n26|17\n26|15\n26|56\n26|62\n26|69\n26|75\n26|98\n26|28\n39|57\n39|27\n39|25\n39|19\n39|99\n39|77\n39|17\n39|47\n39|64\n39|11\n39|52\n39|92\n39|34\n39|82\n39|36\n39|68\n39|59\n39|74\n39|24\n39|87\n39|93\n39|76\n39|72\n39|26\n57|19\n57|83\n57|65\n57|59\n57|36\n57|68\n57|94\n57|26\n57|15\n57|28\n57|81\n57|63\n57|75\n57|91\n57|62\n57|69\n57|29\n57|23\n57|17\n57|55\n57|11\n57|34\n57|33\n57|98\n23|48\n23|77\n23|14\n23|56\n23|92\n23|74\n23|58\n23|72\n23|47\n23|39\n23|25\n23|91\n23|97\n23|76\n23|99\n23|24\n23|49\n23|61\n23|64\n23|27\n23|93\n23|95\n23|82\n23|52\n76|28\n76|11\n76|69\n76|26\n76|81\n76|15\n76|57\n76|83\n76|94\n76|59\n76|33\n76|68\n76|55\n76|19\n76|36\n76|17\n76|34\n76|62\n76|65\n76|98\n76|75\n76|87\n76|63\n76|29\n33|23\n33|97\n33|93\n33|63\n33|91\n33|14\n33|39\n33|74\n33|56\n33|29\n33|72\n33|95\n33|47\n33|55\n33|58\n33|65\n33|83\n33|61\n33|92\n33|48\n33|49\n33|52\n33|69\n33|75\n36|56\n36|69\n36|91\n36|61\n36|23\n36|26\n36|15\n36|75\n36|63\n36|65\n36|49\n36|29\n36|81\n36|17\n36|94\n36|59\n36|62\n36|28\n36|58\n36|33\n36|83\n36|55\n36|98\n36|95\n62|65\n62|58\n62|49\n62|69\n62|39\n62|23\n62|83\n62|98\n62|55\n62|75\n62|63\n62|14\n62|33\n62|74\n62|95\n62|48\n62|97\n62|81\n62|91\n62|15\n62|29\n62|56\n62|92\n62|61\n65|14\n65|64\n65|58\n65|83\n65|74\n65|47\n65|23\n65|93\n65|72\n65|52\n65|48\n65|97\n65|99\n65|92\n65|95\n65|25\n65|61\n65|91\n65|39\n65|82\n65|77\n65|49\n65|56\n65|24\n56|48\n56|77\n56|52\n56|93\n56|57\n56|14\n56|74\n56|39\n56|72\n56|24\n56|99\n56|34\n56|82\n56|64\n56|25\n56|68\n56|19\n56|11\n56|92\n56|76\n56|87\n56|47\n56|97\n56|27\n48|34\n48|76\n48|27\n48|57\n48|47\n48|72\n48|77\n48|39\n48|82\n48|93\n48|52\n48|99\n48|92\n48|24\n48|97\n48|68\n48|36\n48|64\n48|19\n48|14\n48|25\n48|11\n48|87\n95|14\n95|76\n95|77\n95|48\n95|93\n95|82\n95|56\n95|19\n95|24\n95|72\n95|11\n95|92\n95|74\n95|25\n95|68\n95|27\n95|87\n95|64\n95|39\n95|47\n95|57\n95|52\n94|33\n94|91\n94|75\n94|14\n94|48\n94|58\n94|63\n94|81\n94|61\n94|39\n94|62\n94|69\n94|97\n94|28\n94|49\n94|55\n94|15\n94|65\n94|95\n94|29\n94|83\n19|91\n19|26\n19|55\n19|81\n19|36\n19|23\n19|65\n19|94\n19|63\n19|17\n19|59\n19|69\n19|33\n19|68\n19|11\n19|49\n19|28\n19|34\n19|15\n19|29\n83|77\n83|95\n83|47\n83|27\n83|39\n83|56\n83|64\n83|23\n83|72\n83|48\n83|82\n83|25\n83|74\n83|97\n83|14\n83|99\n83|52\n83|24\n83|91\n75|56\n75|61\n75|63\n75|52\n75|49\n75|55\n75|91\n75|74\n75|65\n75|97\n75|92\n75|48\n75|23\n75|95\n75|99\n75|72\n75|93\n75|47\n59|15\n59|33\n59|28\n59|49\n59|81\n59|91\n59|17\n59|58\n59|61\n59|62\n59|26\n59|75\n59|63\n59|56\n59|83\n59|29\n59|48\n77|75\n77|33\n77|63\n77|81\n77|19\n77|55\n77|27\n77|98\n77|17\n77|36\n77|87\n77|59\n77|94\n77|69\n77|29\n77|68\n72|59\n72|94\n72|99\n72|77\n72|11\n72|68\n72|36\n72|24\n72|62\n72|25\n72|82\n72|15\n72|17\n72|64\n72|27\n87|19\n87|83\n87|68\n87|98\n87|59\n87|81\n87|34\n87|28\n87|55\n87|36\n87|26\n87|62\n87|75\n87|15\n99|17\n99|15\n99|26\n99|36\n99|33\n99|98\n99|25\n99|87\n99|57\n99|82\n99|59\n99|11\n99|62\n98|75\n98|56\n98|33\n98|93\n98|49\n98|95\n98|29\n98|65\n98|52\n98|48\n98|83\n98|58\n14|77\n14|24\n14|97\n14|92\n14|52\n14|57\n14|59\n14|72\n14|82\n14|47\n14|74\n27|28\n27|75\n27|63\n27|59\n27|34\n27|81\n27|62\n27|33\n27|11\n27|15\n97|47\n97|77\n97|68\n97|93\n97|76\n97|92\n97|19\n97|26\n97|34\n82|15\n82|26\n82|33\n82|27\n82|17\n82|98\n82|59\n82|75\n63|82\n63|97\n63|49\n63|24\n63|23\n63|99\n63|74\n24|25\n24|94\n24|26\n24|64\n24|87\n24|62\n15|39\n15|97\n15|56\n15|98\n15|93\n52|15\n52|99\n52|17\n52|77\n91|49\n91|74\n91|27\n74|64\n74|99\n34|26\n\n62,15,81,98,69,29,75,63,65,83,91,58,61,95,48,14,97,39,92\n83,23,49,58,61,95,48,97,39,92,47,25,77\n27,26,19,69,94,34,99,87,25\n47,14,27,24,77,19,76,34,72,57,36,74,97,99,93,82,52,68,87,64,25\n64,99,25,77,27,87,57,19,68,11,34,36,26,17,94,62,81,98,33\n28,62,15,98,33,69,29,75,55,83,91,49,58,95,56,14,97\n63,23,39,69,61,65,49\n82,25,77,27,76,87,57,19,68,11,34,36,26,17,94,28,15,81,33,69,29\n58,49,63,91,29,98,83,55,36,69,15,33,26,65,17,94,34,59,75,61,28,23,62\n97,47,58,61,24,93,95,56,25,92,72,64,74,14,39,23,99,83,48\n28,91,55,75,81,23,58,33,59,36,29,62,83,98,65,11,63,94,49,34,26,15,69\n93,52,47,24,99,77,27,76,87,57,68,11,59,26,28\n47,64,25,77,27,76,87,11,34,26,17\n74,52,24,27,34,26,94\n25,17,19,76,15,59,26,57,27,69,81,94,62,36,99,98,28,87,11,77,68,33,34\n91,49,58,61,95,56,14,97,39,92,74,93,52,72,47,24,64,99,82,25,77,27,76\n99,25,77,87,57,19,68,11,34,36,59,26,17,94,28,62,15,81,98,33,69\n24,64,99,82,25,77,76,87,57,19,68,11,34,36,59,26,17,94,28,62,15,81,98\n47,26,15,64,82,25,59,17,34,28,87,11,99,57,19,27,24,62,68\n58,56,39,72,24,77,27,87,57\n26,23,17,63,75,81,59\n52,39,77,24,72,27,47,97,82,93,14,23,92\n93,52,61,69,75,39,98\n65,49,58,39,74,92,56,82,72\n58,95,56,48,14,74,93,52,47,24,64,99,77,27,57\n92,93,49,72,48,58,91,75,65,14,74,39,63,83,61,29,55,23,97\n74,64,82,19,87,57,24,56,76,52,93,27,25,92,72\n19,72,56,99,87,48,76,27,92,77,95,52,68\n57,34,94,98,55\n76,87,19,68,11,34,36,59,62,81,69,75,55,63,65\n48,99,64,92,39,74,49,93,47,24,14,52,72,87,82,58,27\n68,81,29,65,83,23,49\n49,56,62,98,61,69,59,63,23,29,83,81,65,26,17\n29,28,49,11,63,26,94\n63,14,92,24,64,99,82\n64,76,25,72,87,27,97,99,52,34,82,92,68\n58,81,33,91,75,63,74,93,65\n25,87,19,11,34,59,33,29,75\n17,25,59,11,99,57,36\n62,15,98,33,69,29,75,63,83,23,91,49,58,95,56,48,97\n97,92,93,52,72,47,24,64,99,25,77,76,87,57,19,34,59\n52,72,47,82,25,27,76,87,68,11,36,59,94,28,62\n29,59,87,76,36,68,94,28,33,27,77\n92,93,77,27,57,68,11\n93,64,39,92,63,72,82,48,14,65,52,58,24\n72,47,11,34,59,94,15\n33,55,65,49,56,48,14,97,92,74,72\n17,69,83,34,62,49,63,15,59,94,11,28,33,58,55,23,81\n34,61,26,59,91,23,49\n19,68,34,94,81,33,23\n52,24,99,82,25,87,57,59,62\n48,14,97,39,92,74,93,52,24,99,82,25,27,87,57,19,68,11,34\n55,64,39,95,49,24,65,75,23\n63,83,61,93,52,24,82\n62,33,14,48,81,95,15,75,63,69,49,56,65,97,61,23,29,28,58,91,39\n97,39,52,25,27\n33,36,28,17,25,62,81,76,27,19,64\n97,15,98,33,91,65,56,29,74\n29,63,65,47,69,39,49\n36,59,17,94,62,81,98,55,63,83,23,91,58\n95,52,76,14,99,19,48,39,92,82,24,57,74\n64,25,76,68,34,36,59,15,33\n64,39,47,92,87,93,82,24,72,74,48,97,27,14,19,25,11,52,56\n39,92,74,93,52,72,47,24,99,82,25,77,27,76,87,57,19,68,11,34,36,59,26\n94,28,62,15,81,98,33,69,29,75,55,63,83,23,91,49,58,61,95,48,97\n69,63,34,58,33,49,29,75,81,23,26,94,15,65,28,59,17,98,83,61,36\n49,58,95,56,48,14,97,74,93,52,47,24,64,99,25,77,27,76,87\n97,92,74,93,52,72,24,64,99,82,25,77,27,76,87,19,68,11,34,36,59\n56,48,99,91,47,39,23,65,92,64,93,74,49,24,61,58,52,83,97,72,82,14,95\n47,99,82,25,11,34,26,17,62,15,81\n93,82,24,39,64,74,27,97,48,72,56,61,19\n39,52,25,77,76,19,34,36,26\n99,76,87,57,19,68,28,62,69\n76,62,99,82,59,11,27,98,17,57,68,87,77,81,36,19,15,94,34,25,26\n14,33,93,58,49,48,69,63,91,56,29,65,83,39,74,23,61,55,95\n95,48,61,55,75,47,49,56,69\n65,17,59,56,75,55,83,62,15,29,98\n17,94,81,98,33,75,55,63,23,58,61\n48,25,58,24,74,92,49,97,99,14,39,77,64,52,56,61,76,95,91,72,27\n58,29,14,52,95,48,65,75,49,98,69,63,23\n19,68,34,36,94,81,65,83,91\n72,47,24,64,25,27,76,87,57,68,11,36,59,26,94,62,15\n19,34,59,98,69,75,55,83,91\n62,98,29,55,63,65,83,49,58,56,39\n47,72,24,95,93,83,56,91,52,64,77\n36,26,94,15,81,98,33,29,75,63,65,83,23,91,49,61,95\n65,83,23,58,48,97,39,74,72,99,82\n39,34,27,25,47,93,72,92,99,11,74,19,76,24,97,77,57,14,64,48,68,82,52\n75,55,23,91,58,61,56,48,14,97,93,52,72,24,64\n24,27,26,82,93,34,99,72,92,59,74,57,39,76,11,47,36\n64,25,77,76,87,11,36,17,94,28,62,15,81,98,33\n33,28,87,81,83,36,19,63,62,55,68,75,17,15,34,26,94,57,59\n27,76,87,57,19,68,11,34,36,59,26,17,94,28,62,15,81,98,33,69,75,55,63\n76,11,36,59,17,94,15,98,65\n62,57,68,98,11,81,33,59,63,26,19,15,27,29,76\n55,63,65,83,23,91,49,58,48,14,97,92,93,52,72,47,99\n23,52,29,48,39,14,91,93,58,49,61,63,72,74,69,95,65,55,56\n68,87,48,25,95,19,56\n52,72,47,24,64,99,82,25,27,57,34,59,17,94,62\n95,74,25,56,48,87,64,99,47,93,27,52,97,14,77,57,24\n27,87,57,11,34,26,94,28,15,98,33,69,29,75,63\n59,17,94,81,98,69,55,65,23,91,61,95,56\n74,93,36,57,14,34,87\n25,77,76,87,57,19,68,11,36,59,26,17,94,28,81,98,33,69,75\n97,75,39,14,24,56,95,63,65,48,64,23,83,74,61\n26,94,28,62,81,98,33,29,75,55,63,83,91,61,95\n75,55,63,58,29,62,23,91,95,49,65,48,92,15,81\n33,69,29,75,55,63,65,83,23,49,58,61,95,56,48,14,97,39,92,74,93,52,72\n17,56,81,94,91,15,14,62,23\n97,52,72,47,82,27,87,57,34,36,59\n69,55,63,83,23,58,61,56,14,39,92,74,93\n69,68,55,33,63,94,27,75,34,81,87,28,15,19,36,17,57\n39,92,74,87,25,77,36,72,57,76,64,68,26,93,34,47,99\n24,76,26,52,34,19,47,94,59,25,68,11,93,99,87,82,36,17,64,57,27,74,72\n48,24,99,82,25,77,57,11,34\n15,29,75,65,61,48,92\n77,76,75,87,28,94,27,59,57,33,55,81,17,11,29,19,36\n76,87,19,68,11,34,36,59,26,94,28,62,15,81,98,33,69,29,75,55,65\n26,19,87,47,17\n63,65,83,23,91,49,58,61,95,56,48,14,97,39,92,74,93,52,72,47,64,99,82\n61,25,92,52,58,39,47,97,82,72,56,77,64,74,24,14,93,91,23,27,48,99,95\n65,63,15,75,49,81,23,17,68,83,33,36,69,28,94,98,62,91,26,29,59\n91,98,69,97,63,58,49,83,65,61,48,56,23,29,95,52,74\n28,63,61,94,75,97,55,49,23,15,83,62,58,48,69,65,95,98,91\n99,87,17,74,26,25,92,11,57,59,64,77,72,24,76,93,47,19,52,82,27,36,34\n55,65,49,48,97,74,52,47,99\n26,17,28,62,15,81,98,33,69,29,75,55,63,65,83,23,91,49,58,61,95,56,48\n11,26,87,47,57,64,72,92,34\n47,24,64,99,82,77,76,57,68,11,34,59,26,94,62\n61,65,28,75,91,97,62,29,58,56,83,48,81,39,69,95,98\n57,76,75,69,11,77,87,33,62,94,98,26,25,15,36,59,27,28,81,34,19\n99,82,25,77,27,76,87,57,19,68,11,34,36,59,26,17,94,28,62,15,81,33,69\n55,83,23,91,58,61,48,14,39,92,93,47,24,64,99\n62,15,81,98,69,29,75,55,63,65,83,91,49,58,95,56,14,39,92\n52,64,99,48,82,92,47,97,61,58,76,24,25\n94,28,15,81,33,69,29,65,83,23,49,58,61,14,97\n97,24,14,23,58,39,82,92,74,52,61,64,65,91,83\n77,27,19,34,15,81,55\n95,65,83,28,59,98,36,55,91,62,81,33,17,29,94,75,69,23,58\n68,17,94,28,62,15,81,33,69,75,55,63,49\n28,76,33,64,99,34,94\n94,75,26,11,29,34,27,59,76,55,63,36,68,69,62\n63,65,83,23,91,49,58,61,95,56,48,14,39,92,74,93,52,72,47,24,64,99,82\n24,68,92,95,19,72,57,64,56,93,52,97,48,74,27,99,87,77,76\n52,24,25,27,76,87,19,68,11,59,26,94,62\n59,47,64,57,99,87,25,68,19,24,92,39,82,97,34\n83,23,91,49,58,61,95,56,48,14,97,39,92,74,93,52,72,47,24,64,99,82,25\n58,95,56,14,93,52,72,99,27,87,57\n29,55,65,83,23,91,49,58,61,95,48,14,97,39,92,93,52,72,24\n91,49,56,97,92,93,82,77,76\n77,82,68,25,81\n81,69,75,55,63,65,83,23,91,61,56,14,97,74,93\n93,29,58,92,24,61,95,72,91,97,23,56,55,14,65\n25,92,36,34,72,39,26\n99,34,82,57,52,59,19,25,72,93,74,64,47,36,24,97,68,87,39,11,27,77,92\n64,27,76,19,36,59,26,94,33\n25,64,87,52,72,97,77,92,57,48,34\n98,33,69,29,75,55,63,65,83,23,91,49,58,61,56,48,97,39,92,93,52\n59,23,91,49,58\n11,36,94,28,69,55,65,23,91\n26,28,15,81,33,69,29,55,63,65,23,91,49,58,95,56,48\n25,36,93,77,68,64,99,92,57,19,14,74,82\n87,26,59,83,98,65,81,69,62\n27,17,75,11,59,55,34,68,26,33,63,19,29,69,36,28,94,87,15,81,98,62,76\n83,11,91,58,26,34,69\n52,47,24,64,25,77,59,28,62\n75,55,65,83,49,61,92,74,72\n93,19,48,34,25,47,64\n14,97,39,57,68,34,36\n91,62,26,98,49,61,15,17,69,81,23,83,48,56,95,63,94,28,55,58,75\n61,99,52,74,39,93,25,72,91,58,92,23,82,48,47,56,14\n68,26,99,15,64\n69,94,91,48,63,98,75,23,62,26,61,55,65,83,15,56,95\n26,17,94,28,62,15,81,98,75,55,65,83,23,91,58,61,95,56,48\n47,64,58,97,91,14,49,72,52,25,92,24,23,61,93,95,56,99,27,48,77\n28,58,49,81,75,11,15,55,59\n81,33,93,91,48,98,75,61,58\n29,81,75,65,63,58,61,15,62,95,39,92,55,56,49,23,48,91,97,83,69,33,14\n81,98,33,29,75,65,23,95,56,48,97,39,92,74,93\n63,61,55,58,74,72,52,48,65,69,29,23,91,95,92,97,47\n65,81,17,49,69\n92,74,93,52,72,47,24,99,77,76,19,34,36\n92,55,23,39,47,56,72,24,75,93,91,83,52,14,63,74,29\n91,72,56,64,95,47,75\n17,94,27,99,24,82,68,47,64,62,28,77,59,26,36,76,87,34,57\n14,97,92,74,93,47,24,82,77,57,11,34,36\n81,15,76,87,33,28,94,98,75,27,68,55,36,62,77,11,29,69,34\n97,83,23,29,55,58,75,52,91,56,72,61,65,24,74,48,93,92,63\n76,87,57,19,68,11,34,36,59,17,94,28,62,15,81,98,33,69,29,75,55,63,65\n61,95,56,14,39,72,47,24,25,77,87,57,19\n15,23,81,63,59,34,61,91,28,29,65,83,17,55,75,62,98,94,26,33,58,69,49\n82,25,77,27,76,87,57,19,68,11,34,36,59,17,94,28,62,15,81,98,33,69,29\n95,56,48,39,92,93,52,72,47,24,64,82,25,27,76,87,57,19,68\n49,58,92,93,24,64,82,76,87\n49,72,74,93,24,48,99\n59,26,17,94,28,62,15,81,98,33,69,29,75,55,63,65,83,23,91,49,56\n58,15,59,33,65,23,17,95,94,49,28,91,62,69,98\n17,94,28,62,33,69,23,58,56\n59,94,15,98,29,75,23,91,49,58,61,95,56\n34,28,15,76,98,24,57,26,87\n82,27,15,17,64,34,87,57,68,72,24,77,25,19,94,47,36,62,26,59,28,11,99\n93,48,64,14,75,58,97,49,55\n69,55,63,23,91,49,92,72,47\n34,19,36,68,99,69,27,28,81,59,62,87,82\n48,92,52,24,64,99,82,77,76,87,57,11,34\n23,75,91,15,63,55,33,48,61,98,74\n24,76,77,99,27,25,14,92,47,95,87,64,52,56,39,72,49\n64,99,82,25,77,27,76,87,57,19,68,11,34,36,59,26,17,94,28,62,15,81,98";

        var sections = input.Split("\n\n");
        
        var rules = ParseRules(sections[0]);
        var updates = ParseUpdates(sections[1]);

        var result = CalculateMiddlePageSum(rules, updates);

        stopwatch.Stop();
        var elapsedMs = stopwatch.ElapsedMilliseconds;
        Console.WriteLine($"The sum of the middle page numbers of correctly ordered updates is: {result} (elapsed time: {elapsedMs}ms).");
    }
    
    private static List<(int Before, int After)> ParseRules(string rulesSection)
    {
        var rules = new List<(int, int)>();
        foreach (var line in rulesSection.Split("\n", StringSplitOptions.RemoveEmptyEntries))
        {
            var parts = line.Split('|').Select(int.Parse).ToArray();
            rules.Add((parts[0], parts[1]));
        }
        return rules;
    }

    private static List<List<int>> ParseUpdates(string updatesSection)
    {
        var updates = new List<List<int>>();
        foreach (var line in updatesSection.Split("\n", StringSplitOptions.RemoveEmptyEntries))
        {
            var pages = line.Split(',').Select(int.Parse).ToList();
            updates.Add(pages);
        }
        return updates;
    }

    private static int CalculateMiddlePageSum(List<(int Before, int After)> rules, List<List<int>> updates)
    {
        var sum = 0;

        foreach (var update in updates)
        {
            if (IsUpdateValid(rules, update))
            {
                // Calculate the middle page
                var middleIndex = update.Count / 2;
                sum += update[middleIndex];
            }
        }

        return sum;
    }

    private static bool IsUpdateValid(List<(int Before, int After)> rules, List<int> update)
    {
        // Create a position map for fast lookup
        var position = update
            .Select((page, index) => new { page, index })
            .ToDictionary(x => x.page, x => x.index);

        foreach (var (before, after) in rules)
        {
            // Only consider rules where both pages are in the update
            if (position.ContainsKey(before) && position.ContainsKey(after))
            {
                // Check if the order is correct
                if (position[before] > position[after])
                {
                    return false;
                }
            }
        }

        return true;
    }
}